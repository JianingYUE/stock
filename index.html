<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Par Order Tracker</title>
<style>
:root{ --bg:#0b1020; --card:#111731; --ink:#f6f7fb; --muted:#9aa3b2; --accent:#5ed9a6; --line:#202a52; }
*{ box-sizing:border-box }
body{ margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink);
  background: radial-gradient(1200px 600px at 20% -10%, #1b2350 0%, #0b1020 60%); }
.wrap{ max-width:1100px; margin:32px auto; padding:0 16px; }
.card{ background:linear-gradient(180deg,#111731,#0f1430); border:1px solid #1f2750; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
.section{ padding:16px }
header{ display:flex; gap:12px; justify-content:space-between; align-items:center; margin-bottom:16px; }
h1{ font-size:20px; margin:0; letter-spacing:.3px }
.muted{ color:var(--muted); }
.row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
input, button{ color:var(--ink); background:#0e1430; border:1px solid #28315f; border-radius:12px; padding:10px 12px; outline:none }
input::placeholder{ color:#7682a8 }
button{ cursor:pointer }
button.primary{ background:linear-gradient(180deg,#18b76a,#129f5a); border-color:#2abd85 }
button.ghost{ background:#0e1430 }
button:disabled{ opacity:0.4; cursor:not-allowed }
table{ width:100%; border-collapse:collapse }
th, td{ padding:10px; border-bottom:1px solid #232a54; }
th{ text-align:left; color:#b9c1d7; font-weight:600; font-size:13px }
td input{ width:100% }
.pill{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:600 }
.pill.ok{ background:#0f2d1f; color:#68f1b8; border:1px solid #214e3a }
.pill.zero{ background:#141a36; color:#8ca0ff; border:1px solid #273178 }
.footer{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px }
.list{ padding:12px; background:#0c1332; border:1px dashed #293267; border-radius:12px; }
.k{ color:#98a1c4 } .v{ color:#e4e8ff }
.hr{ height:1px; background:#232a54; margin:12px 0 }
.small{ font-size:12px }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "你的Supabase URL";
const SUPABASE_ANON_KEY = "你的Anon Key";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const STATE = {
  period: new Date().getDay() >= 5 ? "FS" : "MT", // Fri-Sun / Mon-Thu
  items: [
    { id:1, item:"Lemon Juice", unit:"bottle", par_mt:2, par_fs:3, notes:"" },
    { id:2, item:"Lime Juice", unit:"bottle", par_mt:2, par_fs:3, notes:"" },
    { id:3, item:"Butter Beer", unit:"case", par_mt:1, par_fs:2, notes:"" }
  ],
  stocks:{},
  name:"anon",
  submitting:false
};

function el(tag, cls, text){
  const e = document.createElement(tag);
  if(cls) e.className = cls;
  if(text!==undefined) e.innerHTML = text;
  return e;
}
function escapeHtml(str){ return String(str).replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c])); }

function render(){
  document.body.innerHTML = "";
  document.body.appendChild(ViewMain());
}

function ViewMain(){
  const period = STATE.period;
  const calcRows = () =>
    STATE.items.map(it => {
      const par   = period === "MT" ? Number(it.par_mt || 0) : Number(it.par_fs || 0);
      const stock = Number(STATE.stocks[it.id] || 0);
      const need  = Math.max(par - stock, 0);
      return { ...it, par, stock, need };
    });
  const buildOrderList = () =>
    calcRows().filter(r => r.need > 0).map(r => ({ item:r.item, unit:r.unit||"", qty:r.need, notes:r.notes||"" }));
  const buildSummaryText = () => {
    const list = buildOrderList();
    if (!list.length) return "";
    return list.map(t => `- ${t.item} — ${t.qty} ${t.unit}`).join("\n");
  };

  const wrap = el("div","wrap");

  const head = el("div","card section");
  head.innerHTML = `<header><h1>Par Order – ${period==='MT'?'Mon–Thu':'Fri–Sun'}</h1></header>
  <p class="muted small">Auto-selected by weekday.</p>`;
  const controls = el("div","row");
  const btnCopy = el("button","ghost","Copy Summary");
  const btnCSV  = el("button","ghost","Export CSV");
  btnCopy.onclick = () => {
    const text = buildSummaryText();
    if (!text) return;
    navigator.clipboard.writeText(text);
    alert("Copied.");
  };
  btnCSV.onclick = () => {
    const list = buildOrderList();
    if (!list.length) return;
    const lines = [["Item","Unit","Qty","Notes"].join(",")];
    list.forEach(it => lines.push([it.item, it.unit||"", String(it.qty), (it.notes||"").replaceAll(",",";")].join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href=url; a.download=`order-${period}.csv`; a.click();
    URL.revokeObjectURL(url);
  };
  controls.append(btnCopy, btnCSV);
  head.appendChild(controls);
  wrap.appendChild(head);

  const tableCard = el("div","card section");
  const table = el("table");
  table.innerHTML = `<thead><tr>
    <th>Item</th><th>Unit</th><th>Par</th><th>Current Stock</th><th>This Order</th><th>Notes</th>
  </tr></thead>`;
  const tbody = el("tbody");

  const previewWrap = el("div","list small", `<div><span class="k">Preview:</span></div>`);
  const previewPre = el("pre","v","");
  previewPre.style.whiteSpace = "pre-wrap";
  previewWrap.appendChild(previewPre);

  const refreshUIState = () => {
    const text = buildSummaryText();
    previewPre.textContent = text;
    const hasItems = !!text;
    btnCopy.disabled = !hasItems;
    btnCSV.disabled  = !hasItems;
  };

  calcRows().forEach(r=>{
    const tr = el("tr");
    const stockInput = el("input");
    stockInput.type="number"; stockInput.step="0.01"; stockInput.min="0";
    stockInput.value = STATE.stocks[r.id] ?? "";
    const pill = el("span","pill " + (r.need>0?"ok":"zero"), r.need>0 ? String(r.need) : "0");
    stockInput.oninput = ()=>{
      const val = Number(stockInput.value || 0);
      STATE.stocks[r.id] = val;
      const need = Math.max(r.par - val, 0);
      pill.textContent = String(need);
      pill.className = "pill " + (need>0 ? "ok" : "zero");
      refreshUIState();
    };
    tr.appendChild(el("td",null,escapeHtml(r.item)));
    tr.appendChild(el("td",null,escapeHtml(r.unit||"")));
    tr.appendChild(el("td",null,String(r.par)));
    const tdS = el("td"); tdS.appendChild(stockInput); tr.appendChild(tdS);
    const tdNeed = el("td"); tdNeed.appendChild(pill); tr.appendChild(tdNeed);
    tr.appendChild(el("td",null,escapeHtml(r.notes||"")));
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  tableCard.appendChild(table);
  wrap.appendChild(tableCard);

  const foot = el("div","card section");
  const row = el("div","row");
  const btnSubmit = el("button","primary","Save Log to Supabase");
  btnSubmit.onclick = async ()=>{
    const freshList = buildOrderList();
    if (!freshList.length && !confirm("No items to order. Save empty log?")) return;
    try{
      await db.from("order_logs").insert({ period, made_by: STATE.name, payload: freshList, stocks: STATE.stocks, generated_at: new Date().toISOString() });
      alert("Saved to Supabase");
    }catch(e){ alert("Error: " + e.message); }
  };
  row.appendChild(btnSubmit);
  foot.appendChild(row);
  foot.appendChild(el("div","hr"));
  foot.appendChild(previewWrap);
  wrap.appendChild(foot);

  refreshUIState();
  return wrap;
}

window.onload = render;
</script>
</head>
<body></body>
</html>
